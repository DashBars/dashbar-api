// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  manager
  cashier
  admin
}

enum BarType {
  VIP
  general
  backstage
  lounge
}

enum BarStatus {
  open
  closed
  lowStock
}

enum PaymentMethod {
  credit
  debit
  cash
  bankTransfer
  wallet
}

enum DrinkType {
  alcoholic
  non_alcoholic
}

enum PosnetStatus {
  OPEN
  CONGESTED
  CLOSED
}

enum POSSaleStatus {
  PENDING
  COMPLETED
  REFUNDED
  VOIDED
}

enum POSPaymentStatus {
  SUCCESS
  FAILED
}

enum AlarmMetric {
  trafic
  lowstock
  closedPostnet
  closedBar
}

enum OwnershipMode {
  purchased
  consignment
}

enum StockLocationType {
  GLOBAL // Inventario global/almacén
  BAR // Barra específica
  PROVIDER // Proveedor (para devoluciones)
}

enum StockMovementReason {
  ASSIGN_TO_BAR // Asignación desde global a barra
  MOVE_BETWEEN_BARS // Movimiento entre barras del mismo evento
  RETURN_TO_GLOBAL // Devolución desde barra a global
  SALE_DECREMENT // Venta (disminución por consumo)
  ADJUSTMENT // Ajuste manual
  RETURN_TO_PROVIDER // Devolución a proveedor (consignación)
  INITIAL_LOAD // Carga inicial en inventario global
}

enum ReturnStatus {
  pending // Pendiente de aprobación
  approved // Aprobado, listo para ejecutar
  completed // Completado (stock devuelto)
  rejected // Rechazado
  cancelled // Cancelado
}

enum StockDepletionPolicy {
  cheapest_first // Deduct cheapest stock first (optimizes costs)
  fifo // First in, first out (by receivedAt)
  consignment_last // Purchased first, consignment last (maximize returns)
}

enum MovementType {
  sale // Deduction from sale
  adjustment // Manual adjustment
  return_ // Return to supplier
  input // Stock input
  transfer_out // Donor: stock leaving
  transfer_in // Receiver: stock arriving
}

enum AlertType {
  low_stock // Stock below lower threshold
  projected_depletion // Projected to deplete within time horizon
}

enum AlertStatus {
  active // Alert is current
  acknowledged // User saw it but no action yet
  resolved // Stock replenished or transferred
  expired // Event ended or no longer relevant
}

enum TransferStatus {
  requested // Receiver requested transfer
  approved // Donor approved
  rejected // Donor rejected
  completed // Stock moved
  cancelled // Request cancelled
}

enum EventStatus {
  upcoming
  active
  finished
  archived
}

enum VenueType {
  outdoor
  indoor
  nose // "no sé" / sin especificar
}

model User {
  id       Int      @id @default(autoincrement())
  email    String   @unique
  password String
  role     UserRole

  eventsOwned           Event[]             @relation("EventOwner")
  suppliers             Supplier[]
  consignmentReturns    ConsignmentReturn[]
  venues                Venue[]
  managerInventories    ManagerInventory[]
  globalInventories     GlobalInventory[]
  inventoryMovements    InventoryMovement[]
  returnPolicies        ReturnPolicy[]
  stockReturnsRequested StockReturn[]       @relation("ReturnRequestedBy")
  stockReturnsApproved  StockReturn[]       @relation("ReturnApprovedBy")
  stockReturnsCompleted StockReturn[]       @relation("ReturnCompletedBy")
  posSessionsOpened     POSSession[]
  posSalesCashier       POSSale[]
  assistantConversations AssistantConversation[]
}

model Venue {
  id           Int       @id @default(autoincrement())
  name         String
  address      String
  addressLine2 String?   @map("address_line_2") // Complemento
  city         String
  state        String? // Provincia/estado
  country      String
  postalCode   String?   @map("postal_code") // Código postal
  capacity     Int
  venueType    VenueType @default(nose) @map("venue_type") // Chip/tag

  // Campos normalizados de Google Places API
  placeId          String? @unique @map("place_id") // Google Places ID
  lat              Float? // Latitud
  lng              Float? // Longitud
  formattedAddress String? @map("formatted_address") // Dirección normalizada completa

  ownerId Int?  @map("owner_id")
  owner   User? @relation(fields: [ownerId], references: [id])

  events Event[]

  @@map("Venue")
}

model Event {
  id               Int         @id @default(autoincrement())
  name             String
  description      String?
  status           EventStatus @default(upcoming) // Estado persistido
  scheduledStartAt DateTime?   @map("scheduled_start_at") // Fecha/hora programada
  startedAt        DateTime?   @map("started_at") // Actual start time (manual)
  finishedAt       DateTime?   @map("finished_at")
  archivedAt       DateTime?   @map("archived_at") // Fecha de archivado

  stockDepletionPolicy StockDepletionPolicy @default(cheapest_first) @map("stock_depletion_policy")

  ownerId Int
  owner   User @relation("EventOwner", fields: [ownerId], references: [id])

  venueId Int
  venue   Venue @relation(fields: [venueId], references: [id])

  bars                 Bar[]
  eventRecipes         EventRecipe[]
  eventPrices          EventPrice[] // DEPRECATED: Use eventProducts instead
  eventProducts        EventProduct[]
  categories           Category[]
  thresholds           StockThreshold[]
  alerts               StockAlert[]
  transfers            StockTransfer[]
  report               EventReport?
  inventoryAllocations ManagerInventoryAllocation[]
  returnPolicy         ReturnPolicy?
  posnets              Posnet[]
  posSales             POSSale[]
  metricSamples        MetricSample[]
  cocktails            Cocktail[] // Event-scoped cocktails

  @@map("Event")
}

// Recipes per bar type within an event
// All bars of the same type share the same recipes
model EventRecipe {
  id           Int     @id @default(autoincrement())
  eventId      Int     @map("event_id")
  cocktailName String  @map("cocktail_name") // Nombre del trago a vender
  glassVolume  Int     @map("glass_volume") // Volumen del vaso en ml
  hasIce       Boolean @default(false) @map("has_ice") // Indica si lleva hielo
  salePrice    Int     @default(0) @map("sale_price") // Precio de venta en centavos (0 si no es producto final)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  barTypes   EventRecipeBarType[]
  components EventRecipeComponent[]

  // Removed unique constraint to allow multiple variants of same cocktail
  // with different configurations for different bar types
  @@index([eventId, cocktailName])
  @@map("event_recipe")
}

// Relación muchos-a-muchos entre EventRecipe y BarType
model EventRecipeBarType {
  eventRecipeId Int     @map("event_recipe_id")
  barType       BarType @map("bar_type")

  eventRecipe EventRecipe @relation(fields: [eventRecipeId], references: [id], onDelete: Cascade)

  @@id([eventRecipeId, barType])
  @@map("event_recipe_bar_type")
}

// Componentes de una receta (insumos con porcentajes)
model EventRecipeComponent {
  id            Int @id @default(autoincrement())
  eventRecipeId Int @map("event_recipe_id")
  drinkId       Int @map("drink_id")
  percentage    Int // Porcentaje del insumo en el cocktail (1-100)

  eventRecipe EventRecipe @relation(fields: [eventRecipeId], references: [id], onDelete: Cascade)
  drink       Drink       @relation(fields: [drinkId], references: [id])

  @@unique([eventRecipeId, drinkId])
  @@map("event_recipe_component")
}

// Products: custom named items that can contain one or multiple cocktails (combos)
// Replaces EventPrice with more flexibility for naming and bundling
model EventProduct {
  id      Int     @id @default(autoincrement())
  eventId Int     @map("event_id")
  barId   Int?    @map("bar_id") // null = producto del evento; set = override por barra
  name    String // Custom name for the product (e.g., "Combo Coca + Sprite")
  price   Int // Price in cents
  isCombo Boolean @default(false) @map("is_combo") // true if contains multiple cocktails

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  bar   Bar?  @relation(fields: [barId], references: [id], onDelete: Cascade)

  cocktails EventProductCocktail[] // Multiple cocktails for combos

  @@unique([eventId, name, barId])
  @@map("event_product")
}

// Join table for EventProduct and Cocktail (many-to-many)
model EventProductCocktail {
  eventProductId Int @map("event_product_id")
  cocktailId     Int @map("cocktail_id")

  eventProduct EventProduct @relation(fields: [eventProductId], references: [id], onDelete: Cascade)
  cocktail     Cocktail     @relation(fields: [cocktailId], references: [id])

  @@id([eventProductId, cocktailId])
  @@map("event_product_cocktail")
}

// Prices: event-level default (barId null) or per-bar override (barId set)
// DEPRECATED: Use EventProduct instead for better flexibility
model EventPrice {
  id         Int  @id @default(autoincrement())
  eventId    Int  @map("event_id")
  cocktailId Int  @map("cocktail_id")
  barId      Int? @map("bar_id") // null = precio por defecto del evento; set = override por barra
  price      Int // in cents

  event    Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  cocktail Cocktail @relation(fields: [cocktailId], references: [id])
  bar      Bar?     @relation(fields: [barId], references: [id], onDelete: Cascade)

  @@unique([eventId, cocktailId, barId])
  @@map("event_price")
}

model Bar {
  id     Int       @id @default(autoincrement())
  name   String
  type   BarType
  status BarStatus @default(closed) // Default closed para eventos upcoming

  eventId Int
  event   Event @relation(fields: [eventId], references: [id])

  stocks               Stock[]
  posnets              Posnet[]
  eventPrices          EventPrice[] // Precios específicos de esta barra (override) - DEPRECATED
  eventProducts        EventProduct[] // Productos específicos de esta barra (override)
  recipeOverrides      BarRecipeOverride[]
  sales                Sale[]
  inventoryMovements   InventoryMovement[]
  alerts               StockAlert[]
  transfersReceived    StockTransfer[]              @relation("TransferReceiver")
  transfersDonated     StockTransfer[]              @relation("TransferDonor")
  inventoryAllocations ManagerInventoryAllocation[]
  stockReturns         StockReturn[]
  posSales             POSSale[]
  metricSamples        MetricSample[]
}

model Stock {
  barId      Int @map("bar_id")
  drinkId    Int @map("drink_id")
  supplierId Int @map("supplier_id")

  quantity      Int
  unitCost      Int           @map("unit_cost") // cost in cents
  currency      String        @default("ARS")
  ownershipMode OwnershipMode @map("ownership_mode")
  receivedAt    DateTime      @default(now()) @map("received_at")

  // Venta directa: si true, el insumo se vende como unidad completa (ej: botella de agua)
  // Si false, solo se usa como componente de recetas
  // Forma parte de la clave primaria para permitir ambos usos del mismo producto
  sellAsWholeUnit Boolean @default(false) @map("sell_as_whole_unit")
  salePrice       Int?    @map("sale_price") // Precio de venta en centavos (requerido si sellAsWholeUnit=true)

  bar      Bar      @relation(fields: [barId], references: [id])
  drink    Drink    @relation(fields: [drinkId], references: [id])
  supplier Supplier @relation(fields: [supplierId], references: [id])

  consignmentReturns ConsignmentReturn[]

  // Incluye sellAsWholeUnit en la clave para permitir stock separado para venta directa vs recetas
  @@id([barId, drinkId, supplierId, sellAsWholeUnit])
}

model Posnet {
  id      Int          @id @default(autoincrement())
  code    String       @unique // Human-friendly short code (e.g., "POS-001")
  name    String // Descriptive name
  status  PosnetStatus @default(CLOSED)
  enabled Boolean      @default(true)
  traffic Int          @default(0) // %

  eventId Int @map("event_id")
  barId   Int @map("bar_id")

  authToken       String?   @map("auth_token") // For POS device login
  lastHeartbeatAt DateTime? @map("last_heartbeat_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  bar   Bar   @relation(fields: [barId], references: [id], onDelete: Cascade)

  sessions      POSSession[]
  sales         POSSale[]
  metricSamples MetricSample[]

  @@map("posnet")
}

model Cocktail {
  id          Int     @id @default(autoincrement())
  eventId     Int?    @map("event_id") // Event scope (null = legacy global cocktails)
  name        String
  description String?
  imageUrl    String? @map("image_url")
  sku         String? @unique // Unique code for POS
  price       Int // base price in cents (can be overridden by EventPrice)
  volume      Int // ml
  isActive    Boolean @default(true) @map("is_active")
  isCombo     Boolean @default(false) @map("is_combo")

  event                 Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventPrices           EventPrice[] // DEPRECATED
  eventProductCocktails EventProductCocktail[]
  recipeOverrides       BarRecipeOverride[]
  sales                 Sale[]
  categories            CocktailCategory[]

  @@unique([eventId, name]) // Unique name per event
}

model Drink {
  id        Int       @id @default(autoincrement())
  name      String
  brand     String
  sku       String    @unique // Unique code for supplier traceability
  drinkType DrinkType
  volume    Int // ml

  stocks                Stock[]
  eventRecipeComponents EventRecipeComponent[]
  recipeOverrides       BarRecipeOverride[]
  inventoryMovements    InventoryMovement[]
  thresholds            StockThreshold[]
  alerts                StockAlert[]
  transfers             StockTransfer[]
  managerInventories    ManagerInventory[]
  globalInventories     GlobalInventory[]
  stockReturns          StockReturn[]
}

model AlarmConfig {
  id          Int         @id @default(autoincrement())
  name        String
  description String?
  value       Int
  metric      AlarmMetric
}

model Supplier {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  email       String?
  phone       String?

  ownerId Int  @map("owner_id")
  owner   User @relation(fields: [ownerId], references: [id])

  stocks             Stock[]
  consignmentReturns ConsignmentReturn[]
  inventoryMovements InventoryMovement[]
  managerInventories ManagerInventory[]
  globalInventories  GlobalInventory[]
  stockReturns       StockReturn[]

  @@map("supplier")
}

model ConsignmentReturn {
  id Int @id @default(autoincrement())

  stockBarId           Int     @map("stock_bar_id")
  stockDrinkId         Int     @map("stock_drink_id")
  stockSupplierId      Int     @map("stock_supplier_id")
  stockSellAsWholeUnit Boolean @default(false) @map("stock_sell_as_whole_unit")

  supplierId       Int      @map("supplier_id")
  quantityReturned Int      @map("quantity_returned")
  returnedAt       DateTime @default(now()) @map("returned_at")
  notes            String?

  // Audit: who performed the return
  performedById Int  @map("performed_by_id")
  performedBy   User @relation(fields: [performedById], references: [id])

  stock    Stock    @relation(fields: [stockBarId, stockDrinkId, stockSupplierId, stockSellAsWholeUnit], references: [barId, drinkId, supplierId, sellAsWholeUnit])
  supplier Supplier @relation(fields: [supplierId], references: [id])

  @@map("consignment_return")
}

// Bar-specific recipe override (takes precedence over EventRecipe by barType)
model BarRecipeOverride {
  id                 Int @id @default(autoincrement())
  barId              Int @map("bar_id")
  cocktailId         Int @map("cocktail_id")
  drinkId            Int @map("drink_id")
  cocktailPercentage Int @map("cocktail_percentage") // %

  bar      Bar      @relation(fields: [barId], references: [id], onDelete: Cascade)
  cocktail Cocktail @relation(fields: [cocktailId], references: [id])
  drink    Drink    @relation(fields: [drinkId], references: [id])

  @@unique([barId, cocktailId, drinkId])
  @@map("bar_recipe_override")
}

// Inventory movement for audit trail (extended with location tracking)
model InventoryMovement {
  id Int @id @default(autoincrement())

  // Location tracking (from/to)
  fromLocationType StockLocationType? @map("from_location_type")
  fromLocationId   Int?               @map("from_location_id") // barId o null (global)
  toLocationType   StockLocationType? @map("to_location_type")
  toLocationId     Int?               @map("to_location_id") // barId o null (global)

  // Campos existentes (barId deprecated, usar toLocationId)
  barId           Int?                 @map("bar_id") // DEPRECATED: usar toLocationId
  drinkId         Int                  @map("drink_id")
  supplierId      Int                  @map("supplier_id")
  quantity        Int // Negative for deductions, positive for additions
  type            MovementType
  reason          StockMovementReason? // Razón específica del movimiento
  sellAsWholeUnit Boolean?             @map("sell_as_whole_unit") // Para diferenciar venta directa vs receta
  referenceId     Int?                 @map("reference_id") // saleId, returnId, etc.
  notes           String?
  createdAt       DateTime             @default(now()) @map("created_at")

  // Audit
  performedById Int?  @map("performed_by_id") // Usuario que ejecutó
  performedBy   User? @relation(fields: [performedById], references: [id])

  // Relaciones
  bar      Bar?     @relation(fields: [barId], references: [id])
  drink    Drink    @relation(fields: [drinkId], references: [id])
  supplier Supplier @relation(fields: [supplierId], references: [id])

  // Relación con inventario global
  globalInventoryId Int?             @map("global_inventory_id")
  globalInventory   GlobalInventory? @relation(fields: [globalInventoryId], references: [id])

  @@index([barId, type])
  @@index([barId, drinkId, supplierId])
  @@map("inventory_movement")
}

// Sale record (triggers automatic stock depletion)
model Sale {
  id         Int      @id @default(autoincrement())
  barId      Int      @map("bar_id")
  cocktailId Int      @map("cocktail_id")
  quantity   Int // Number of cocktails sold
  createdAt  DateTime @default(now()) @map("created_at")

  bar      Bar      @relation(fields: [barId], references: [id])
  cocktail Cocktail @relation(fields: [cocktailId], references: [id])

  @@index([barId, createdAt])
  @@map("sale")
}

// Category for organizing products in POS menu
model Category {
  id          Int     @id @default(autoincrement())
  eventId     Int     @map("event_id")
  name        String
  description String?
  sortIndex   Int     @default(0) @map("sort_index")
  isActive    Boolean @default(true) @map("is_active")

  event     Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  cocktails CocktailCategory[]

  @@unique([eventId, name])
  @@map("category")
}

// Many-to-many relation between Category and Cocktail
model CocktailCategory {
  categoryId Int @map("category_id")
  cocktailId Int @map("cocktail_id")
  sortIndex  Int @default(0) @map("sort_index")

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  cocktail Cocktail @relation(fields: [cocktailId], references: [id], onDelete: Cascade)

  @@id([categoryId, cocktailId])
  @@map("cocktail_category")
}

// Configurable stock thresholds per event, drink and stock type
model StockThreshold {
  id                  Int     @id @default(autoincrement())
  eventId             Int     @map("event_id")
  drinkId             Int     @map("drink_id")
  sellAsWholeUnit     Boolean @default(false) @map("sell_as_whole_unit") // true = venta directa, false = para recetas
  lowerThreshold      Int     @map("lower_threshold") // Critical floor in units
  donationThreshold   Int     @map("donation_threshold") // Surplus level in units
  depletionHorizonMin Int?    @map("depletion_horizon_min") // Optional: minutes for projection

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  drink Drink @relation(fields: [drinkId], references: [id])

  @@unique([eventId, drinkId, sellAsWholeUnit])
  @@map("stock_threshold")
}

// Stock alerts for low stock and projected depletion
model StockAlert {
  id               Int         @id @default(autoincrement())
  eventId          Int         @map("event_id")
  barId            Int         @map("bar_id")
  drinkId          Int         @map("drink_id")
  sellAsWholeUnit  Boolean     @default(false) @map("sell_as_whole_unit")
  type             AlertType
  status           AlertStatus @default(active)
  currentStock     Int         @map("current_stock") // in units
  threshold        Int // The threshold that was breached (units)
  suggestedDonors  Json?       @map("suggested_donors") // Array of donor suggestions
  externalNeeded   Boolean     @default(false) @map("external_needed")
  projectedMinutes Int?        @map("projected_minutes") // Time to depletion
  message          String?     // Human-readable alert message
  createdAt        DateTime    @default(now()) @map("created_at")
  resolvedAt       DateTime?   @map("resolved_at")

  event Event @relation(fields: [eventId], references: [id])
  bar   Bar   @relation(fields: [barId], references: [id])
  drink Drink @relation(fields: [drinkId], references: [id])

  @@map("stock_alert")
}

// Stock transfer requests between bars
model StockTransfer {
  id            Int            @id @default(autoincrement())
  eventId       Int            @map("event_id")
  receiverBarId Int            @map("receiver_bar_id")
  donorBarId    Int            @map("donor_bar_id")
  drinkId       Int            @map("drink_id")
  quantity      Int // ml to transfer
  status        TransferStatus @default(requested)
  alertId       Int?           @map("alert_id") // Optional link to originating alert
  requestedAt   DateTime       @default(now()) @map("requested_at")
  approvedAt    DateTime?      @map("approved_at")
  completedAt   DateTime?      @map("completed_at")
  notes         String?

  event       Event @relation(fields: [eventId], references: [id])
  receiverBar Bar   @relation("TransferReceiver", fields: [receiverBarId], references: [id])
  donorBar    Bar   @relation("TransferDonor", fields: [donorBarId], references: [id])
  drink       Drink @relation(fields: [drinkId], references: [id])

  @@map("stock_transfer")
}

// Post-event report with aggregated metrics
model EventReport {
  id          Int      @id @default(autoincrement())
  eventId     Int      @unique @map("event_id")
  generatedAt DateTime @default(now()) @map("generated_at")

  // Summary totals
  totalRevenue    BigInt @map("total_revenue") // cents
  totalCOGS       BigInt @map("total_cogs") // cents
  grossProfit     BigInt @map("gross_profit") // cents
  totalUnitsSold  Int    @map("total_units_sold")
  totalOrderCount Int    @map("total_order_count")

  // Detailed data (JSON)
  topProducts        Json @map("top_products") // Array of top sellers
  peakHours          Json @map("peak_hours") // Peak time windows (legacy, 60-min buckets)
  timeSeries         Json @map("time_series") // Bucketed data for charts
  remainingStock     Json @map("remaining_stock") // Stock snapshot with valuation
  consumptionByDrink Json @map("consumption_by_drink") // COGS breakdown

  // Enhanced peak hours by bucket size (5, 15, 60 minutes)
  peakHours5min  Json? @map("peak_hours_5min") // Array of {startTime, endTime, salesCount, revenue, topProduct}
  peakHours15min Json? @map("peak_hours_15min")
  peakHours60min Json? @map("peak_hours_60min")

  // Per-bar and per-POS breakdowns
  barBreakdowns Json? @map("bar_breakdowns") // Per-bar stats
  posBreakdowns Json? @map("pos_breakdowns") // Per-POS terminal stats

  // Stock valuation details
  stockValuation Json? @map("stock_valuation") // {totalValue, byBar: [...]}
  cogsBreakdown  Json? @map("cogs_breakdown") // Cost of goods sold details by bar

  // Export file paths
  csvPath String? @map("csv_path") // Path to generated CSV
  pdfPath String? @map("pdf_path") // Path to generated PDF

  // Metadata
  warnings String[] @default([]) // Missing data warnings

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_report")
}

model ManagerInventory {
  id         Int @id @default(autoincrement())
  ownerId    Int @map("owner_id")
  drinkId    Int @map("drink_id")
  supplierId Int @map("supplier_id")

  totalQuantity     Int      @map("total_quantity") // Cantidad total disponible
  allocatedQuantity Int      @default(0) @map("allocated_quantity") // Cantidad asignada a barras
  unitCost          Int      @map("unit_cost") // Costo unitario en centavos
  currency          String   @default("ARS")
  sku               String? // SKU del proveedor (puede diferir del SKU del Drink)
  receivedAt        DateTime @default(now()) @map("received_at")

  owner    User     @relation(fields: [ownerId], references: [id])
  drink    Drink    @relation(fields: [drinkId], references: [id])
  supplier Supplier @relation(fields: [supplierId], references: [id])

  allocations ManagerInventoryAllocation[]

  @@unique([ownerId, drinkId, supplierId])
  @@map("manager_inventory")
}

model ManagerInventoryAllocation {
  id                 Int      @id @default(autoincrement())
  managerInventoryId Int      @map("manager_inventory_id")
  eventId            Int      @map("event_id")
  barId              Int      @map("bar_id")
  quantity           Int // Cantidad transferida
  allocatedAt        DateTime @default(now()) @map("allocated_at")

  managerInventory ManagerInventory @relation(fields: [managerInventoryId], references: [id], onDelete: Cascade)
  event            Event            @relation(fields: [eventId], references: [id])
  bar              Bar              @relation(fields: [barId], references: [id])

  @@map("manager_inventory_allocation")
}

// Inventario global (almacén general) independiente de eventos/barras
model GlobalInventory {
  id            Int           @id @default(autoincrement())
  ownerId       Int           @map("owner_id")
  drinkId       Int           @map("drink_id")
  supplierId    Int?          @map("supplier_id") // Opcional: puede ser stock sin proveedor
  ownershipMode OwnershipMode @default(purchased) @map("ownership_mode")

  totalQuantity     Int     @map("total_quantity") // Cantidad total disponible
  allocatedQuantity Int     @default(0) @map("allocated_quantity") // Asignada a barras
  unitCost          Int     @map("unit_cost") // Costo unitario en centavos
  currency          String  @default("ARS")
  sku               String? // SKU del proveedor

  receivedAt    DateTime @default(now()) @map("received_at")
  lastUpdatedAt DateTime @default(now()) @updatedAt @map("last_updated_at")

  owner    User      @relation(fields: [ownerId], references: [id])
  drink    Drink     @relation(fields: [drinkId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  // Relaciones con movimientos
  stockMovements InventoryMovement[]

  @@unique([ownerId, drinkId, supplierId])
  @@map("global_inventory")
}

// Política de devolución para eventos
model ReturnPolicy {
  id      Int @id @default(autoincrement())
  eventId Int @unique @map("event_id")
  ownerId Int @map("owner_id")

  // Configuración
  autoReturnToGlobal Boolean @default(true) @map("auto_return_to_global") // Auto-devolver stock sobrante
  requireApproval    Boolean @default(false) @map("require_approval") // Requiere aprobación para devoluciones

  // Tracking
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  owner User  @relation(fields: [ownerId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  returns StockReturn[]

  @@map("return_policy")
}

// Devolución de stock
model StockReturn {
  id         Int  @id @default(autoincrement())
  policyId   Int  @map("policy_id")
  barId      Int  @map("bar_id")
  drinkId    Int  @map("drink_id")
  supplierId Int? @map("supplier_id")

  quantity      Int
  unitCost      Int           @map("unit_cost")
  currency      String        @default("ARS")
  ownershipMode OwnershipMode @map("ownership_mode")

  status ReturnStatus @default(pending)
  reason String? // Motivo de devolución
  notes  String?

  // Tracking
  requestedAt DateTime? @map("requested_at")
  approvedAt  DateTime? @map("approved_at")
  completedAt DateTime? @map("completed_at")

  requestedById Int? @map("requested_by_id")
  approvedById  Int? @map("approved_by_id")
  completedById Int? @map("completed_by_id")

  requestedBy User? @relation("ReturnRequestedBy", fields: [requestedById], references: [id])
  approvedBy  User? @relation("ReturnApprovedBy", fields: [approvedById], references: [id])
  completedBy User? @relation("ReturnCompletedBy", fields: [completedById], references: [id])

  policy   ReturnPolicy @relation(fields: [policyId], references: [id])
  bar      Bar          @relation(fields: [barId], references: [id])
  drink    Drink        @relation(fields: [drinkId], references: [id])
  supplier Supplier?    @relation(fields: [supplierId], references: [id])

  @@map("stock_return")
}

// =============================================================================
// POS (Point of Sale) System Models
// =============================================================================

// POS Session - tracks when a POS terminal is opened/closed
model POSSession {
  id             Int       @id @default(autoincrement())
  posnetId       Int       @map("posnet_id")
  openedByUserId Int       @map("opened_by_user_id")
  openedAt       DateTime  @default(now()) @map("opened_at")
  closedAt       DateTime? @map("closed_at")
  openingFloat   Int?      @map("opening_float") // Starting cash in drawer (cents)
  closingFloat   Int?      @map("closing_float") // Ending cash in drawer (cents)
  notes          String?

  posnet   Posnet    @relation(fields: [posnetId], references: [id], onDelete: Cascade)
  openedBy User      @relation(fields: [openedByUserId], references: [id])
  sales    POSSale[]

  @@map("pos_session")
}

// POS Sale - a completed sale transaction at a POS terminal
model POSSale {
  id            Int           @id @default(autoincrement())
  posnetId      Int           @map("posnet_id")
  sessionId     Int?          @map("session_id")
  eventId       Int           @map("event_id")
  barId         Int           @map("bar_id")
  cashierUserId Int?          @map("cashier_user_id")
  status        POSSaleStatus @default(COMPLETED)

  subtotal Int // cents (before tax)
  tax      Int @default(0) // cents
  total    Int // cents (subtotal + tax)

  idempotencyKey String?  @unique @map("idempotency_key")
  createdAt      DateTime @default(now()) @map("created_at")

  posnet  Posnet      @relation(fields: [posnetId], references: [id], onDelete: Cascade)
  session POSSession? @relation(fields: [sessionId], references: [id])
  event   Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  bar     Bar         @relation(fields: [barId], references: [id], onDelete: Cascade)
  cashier User?       @relation(fields: [cashierUserId], references: [id])

  items    POSSaleItem[]
  payments POSPayment[]

  @@index([eventId, status, createdAt])
  @@index([barId, status, createdAt])
  @@map("pos_sale")
}

// POS Sale Item - individual line items in a sale
model POSSaleItem {
  id                  Int    @id @default(autoincrement())
  saleId              Int    @map("sale_id")
  productId           Int?   @map("product_id") // Reference to EventProduct (can be null if product deleted)
  cocktailId          Int?   @map("cocktail_id") // Reference to Cocktail for stock depletion
  productNameSnapshot String @map("product_name_snapshot") // Snapshot of product name at sale time
  unitPriceSnapshot   Int    @map("unit_price_snapshot") // Snapshot of unit price (cents)
  quantity            Int
  lineTotal           Int    @map("line_total") // quantity * unitPriceSnapshot (cents)

  sale POSSale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@map("pos_sale_item")
}

// POS Payment - payment record for a sale
model POSPayment {
  id             Int              @id @default(autoincrement())
  saleId         Int              @map("sale_id")
  method         PaymentMethod // CASH, CARD, etc.
  amount         Int // cents
  currency       String           @default("ARS")
  status         POSPaymentStatus @default(SUCCESS)
  idempotencyKey String?          @unique @map("idempotency_key")
  externalRef    String?          @map("external_ref") // External payment reference (card processor, etc.)
  createdAt      DateTime         @default(now()) @map("created_at")

  sale POSSale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("pos_payment")
}

// Metric Sample - time-series metrics for POS/bar/event analytics
model MetricSample {
  id          Int      @id @default(autoincrement())
  posnetId    Int?     @map("posnet_id")
  barId       Int?     @map("bar_id")
  eventId     Int      @map("event_id")
  metricType  String   @map("metric_type") // TPS, AVG_CHECKOUT_MS, QUEUE_LEN, SALES_COUNT, etc.
  value       Float
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  createdAt   DateTime @default(now()) @map("created_at")

  posnet Posnet? @relation(fields: [posnetId], references: [id], onDelete: Cascade)
  bar    Bar?    @relation(fields: [barId], references: [id], onDelete: Cascade)
  event  Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, metricType, periodStart])
  @@index([posnetId, metricType, periodStart])
  @@map("metric_sample")
}

// ─── AI Assistant ────────────────────────────────────────

model AssistantConversation {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  title     String?
  messages  AssistantMessage[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, updatedAt])
  @@map("assistant_conversation")
}

model AssistantMessage {
  id             Int      @id @default(autoincrement())
  conversationId Int      @map("conversation_id")
  role           String   // "user" | "assistant"
  content        String
  toolCalls      Json?    @map("tool_calls")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation AssistantConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("assistant_message")
}
